
===== pytest run 2025-12-16 16:04:01 args=['tests/test_context_menu_effect_invalidation.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 1 item



tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup 
FAILED                               [100%]




================================================================== FAILURES ==================================================================

_____________________________________________ test_context_menu_invalidates_effects_before_popup _____________________________________________



qt_app = <PySide6.QtWidgets.QApplication(0x1645f1882e0) at 0x000001647E716080>, qtbot = <pytestqt.qtbot.QtBot object at 0x000001647E7163D0>

settings_manager = <core.settings.settings_manager.SettingsManager(0x1645f18a4e0) at 0x000001647E716780>

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001647E728650>



    @pytest.mark.qt

    def test_context_menu_invalidates_effects_before_popup(qt_app, qtbot, settings_manager, monkeypatch):

        widget = DisplayWidget(screen_index=0, display_mode=None, settings_manager=settings_manager)

        qtbot.addWidget(widget)

        widget.resize(640, 360)

    

        dummy = QWidget(widget)

        dummy.resize(20, 20)

        dummy.show()

    

        eff = QGraphicsDropShadowEffect(dummy)

        dummy.setGraphicsEffect(eff)

    

        events: List[Tuple[str, object]] = []

    

>       orig_invalidate = widget._invalidate_overlay_effects  # type: ignore[attr-defined]

                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

E       AttributeError: 'DisplayWidget' object has no attribute '_invalidate_overlay_effects'



tests\test_context_menu_effect_invalidation.py:29: AttributeError

----------------------------------------------------------- Captured log teardown ------------------------------------------------------------

WARNING  SettingsManager:settings_manager.py:842 All settings cleared

========================================================== short test summary info ===========================================================

FAILED tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup - AttributeError: 'DisplayWidget' object has no attribute '_invalidate_overlay_effects'

============================================================= 1 failed in 0.70s ==============================================================


===== pytest run 2025-12-16 16:14:29 args=['tests/test_spotify_visualizer_widget.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 6 items



tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_tick_consumes_engine_smoothed_bars 
PASSED                              [ 16%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_compute_bars_reasonable_runtime 
PASSED                                 [ 33%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_widgets_share_audio_engine 
PASSED                                      [ 50%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_emits_perf_metrics 
PASSED                                              [ 66%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_bars_not_stuck_at_top 
PASSED                                           [ 83%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_kick_emphasizes_center_more_than_vocals 
PASSED                         [100%]




============================================================= 6 passed in 0.46s ==============================================================


===== pytest run 2025-12-16 16:40:41 args=['tests/test_spotify_visualizer_widget.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 6 items



tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_tick_consumes_engine_smoothed_bars 
PASSED                              [ 16%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_compute_bars_reasonable_runtime 
PASSED                                 [ 33%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_widgets_share_audio_engine 
PASSED                                      [ 50%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_emits_perf_metrics 
PASSED                                              [ 66%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_bars_not_stuck_at_top 
FAILED                                           [ 83%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_kick_emphasizes_center_more_than_vocals 
FAILED                         [100%]




================================================================== FAILURES ==================================================================

_______________________________________________ test_spotify_visualizer_bars_not_stuck_at_top ________________________________________________



    def test_spotify_visualizer_bars_not_stuck_at_top():

        try:

            import numpy as np  # type: ignore[import]

        except Exception:

            pytest.skip("numpy not available for Spotify visualiser tests")

    

        buf: TripleBuffer[_AudioFrame] = TripleBuffer()

        worker = SpotifyVisualizerAudioWorker(bar_count=15, buffer=buf)

        worker._np = np  # type: ignore[attr-defined]

    

        n_samples = 2048

        sample_rate = 48000

        t = np.arange(n_samples, dtype=np.float32) / np.float32(sample_rate)

    

        bars_center = []

        frames = 120

        for frame in range(frames):

            intensity = np.float32(0.1 + 0.9 * (0.5 + 0.5 * np.sin(np.float32(2.0 * np.pi) * np.float32(frame) / np.float32(60.0))))

            env = np.exp(-t * np.float32(20.0)).astype(np.float32)

            base = (np.sin(np.float32(2.0 * np.pi * 80.0) * t) * env).astype(np.float32)

            samples = (base * (np.float32(0.03) * intensity)).astype(np.float32)

            bars = worker.compute_bars_from_samples(samples)

            if not isinstance(bars, list) or not bars:

                continue

            center_idx = len(bars) // 2

            bars_center.append(float(bars[center_idx]))

    

        assert bars_center

    

        center_arr = np.asarray(bars_center, dtype=np.float32)

        cmin = float(center_arr.min())

        cmax = float(center_arr.max())

        stuck_frac = float(np.mean(center_arr >= np.float32(0.98)))

        crange = cmax - cmin

    

        assert cmax >= 0.25

        assert crange >= 0.15

>       assert stuck_frac <= 0.55

E       assert 0.7166666666666667 <= 0.55



tests\test_spotify_visualizer_widget.py:167: AssertionError

______________________________________ test_spotify_visualizer_kick_emphasizes_center_more_than_vocals _______________________________________



    def test_spotify_visualizer_kick_emphasizes_center_more_than_vocals():

        try:

            import numpy as np  # type: ignore[import]

        except Exception:

            pytest.skip("numpy not available for Spotify visualiser tests")

    

        buf: TripleBuffer[_AudioFrame] = TripleBuffer()

        worker = SpotifyVisualizerAudioWorker(bar_count=15, buffer=buf)

        worker._np = np  # type: ignore[attr-defined]

    

        n_samples = 2048

        sample_rate = 48000

        t = np.arange(n_samples, dtype=np.float32) / np.float32(sample_rate)

    

        env = np.exp(-t * np.float32(18.0)).astype(np.float32)

        kick_base = (np.sin(np.float32(2.0 * np.pi * 80.0) * t) * env).astype(np.float32)

        vocal_base = (

            np.sin(np.float32(2.0 * np.pi * 1000.0) * t) * np.float32(0.7)

            + np.sin(np.float32(2.0 * np.pi * 2000.0) * t) * np.float32(0.5)

        ).astype(np.float32)

    

        kick_samples = (kick_base * np.float32(0.03)).astype(np.float32)

        vocal_samples = (vocal_base * np.float32(0.03)).astype(np.float32)

    

        kick_bars = worker.compute_bars_from_samples(kick_samples)

        vocal_bars = worker.compute_bars_from_samples(vocal_samples)

    

        assert isinstance(kick_bars, list) and len(kick_bars) >= 5

        assert isinstance(vocal_bars, list) and len(vocal_bars) >= 5

    

        n = len(kick_bars)

        c = n // 2

        q = n // 4

        tq = (3 * n) // 4

    

        center_kick = float(np.mean(kick_bars[max(0, c - 1):min(n, c + 2)]))

        shoulder_kick = float((kick_bars[q] + kick_bars[tq]) * 0.5)

    

        center_vocal = float(np.mean(vocal_bars[max(0, c - 1):min(n, c + 2)]))

        shoulder_vocal = float((vocal_bars[q] + vocal_bars[tq]) * 0.5)

    

>       assert (center_kick - shoulder_kick) > (center_vocal - shoulder_vocal)

E       assert (1.0 - 1.0) > (1.0 - 0.8200823068618774)



tests\test_spotify_visualizer_widget.py:211: AssertionError

========================================================== short test summary info ===========================================================

FAILED tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_bars_not_stuck_at_top - assert 0.7166666666666667 <= 0.55

FAILED tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_kick_emphasizes_center_more_than_vocals - assert (1.0 - 1.0) > (1.0 - 0.8200823068618774)

======================================================== 2 failed, 4 passed in 0.60s =========================================================


===== pytest run 2025-12-16 16:40:43 args=['tests/test_context_menu_effect_invalidation.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 1 item



tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup 
FAILED                               [100%]




================================================================== FAILURES ==================================================================

_____________________________________________ test_context_menu_invalidates_effects_before_popup _____________________________________________



qt_app = <PySide6.QtWidgets.QApplication(0x1b932c68220) at 0x000001B96242FF80>, qtbot = <pytestqt.qtbot.QtBot object at 0x000001B9627506D0>

settings_manager = <core.settings.settings_manager.SettingsManager(0x1b932c6a5a0) at 0x000001B962750AC0>

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001B962753F50>



    @pytest.mark.qt

    def test_context_menu_invalidates_effects_before_popup(qt_app, qtbot, settings_manager, monkeypatch):

        widget = DisplayWidget(screen_index=0, display_mode=None, settings_manager=settings_manager)

        qtbot.addWidget(widget)

        widget.resize(640, 360)

    

        dummy = QWidget(widget)

        dummy.resize(20, 20)

        dummy.show()

    

        eff = QGraphicsDropShadowEffect(dummy)

        dummy.setGraphicsEffect(eff)

    

        events: List[Tuple[str, object]] = []

    

        orig_invalidate = widget._invalidate_overlay_effects  # type: ignore[attr-defined]

    

        def _spy_invalidate(reason: str) -> None:

            events.append(("invalidate", reason))

            orig_invalidate(reason)

    

        monkeypatch.setattr(widget, "_invalidate_overlay_effects", _spy_invalidate)

    

        last_popup_menu: List[object] = []

    

        def _spy_popup(self, pos):  # type: ignore[no-untyped-def]

            last_popup_menu.clear()

            last_popup_menu.append(self)

            events.append(("popup", pos))

            assert any(e[0] == "invalidate" for e in events)

    

        monkeypatch.setattr(ScreensaverContextMenu, "popup", _spy_popup)

    

        widget.clock_widget = dummy  # type: ignore[assignment]

    

        effect_ids: List[int] = []

    

        for i in range(25):

            events.clear()

            widget._show_context_menu(QPoint(10 + i, 10))  # type: ignore[attr-defined]

            qt_app.processEvents()

            assert events

    

            try:

                active_eff = dummy.graphicsEffect()

            except Exception:

                active_eff = None

            assert isinstance(active_eff, QGraphicsDropShadowEffect)

            effect_ids.append(id(active_eff))

    

            invalidate_idx = next(idx for idx, e in enumerate(events) if e[0] == "invalidate")

            popup_idx = next(idx for idx, e in enumerate(events) if e[0] == "popup")

            assert invalidate_idx < popup_idx

    

            menu = last_popup_menu[0] if last_popup_menu else None

            assert menu is not None

            try:

                menu.aboutToHide.emit()

            except Exception:

                pass

            qt_app.processEvents()

    

            assert any(

                e[0] == "invalidate" and str(e[1]).startswith("menu_after_hide")

                for e in events

            )

    

>       assert len(set(effect_ids)) >= 2

E       assert 1 >= 2

E        +  where 1 = len({1895730858304})

E        +    where {1895730858304} = set([1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304])



tests\test_context_menu_effect_invalidation.py:81: AssertionError

----------------------------------------------------------- Captured log teardown ------------------------------------------------------------

WARNING  SettingsManager:settings_manager.py:842 All settings cleared

========================================================== short test summary info ===========================================================

FAILED tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup - assert 1 >= 2
 +  where 1 = len({1895730858304})
 +    where {1895730858304} = set([1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304, 1895730858304])


============================================================= 1 failed in 0.87s ==============================================================


===== pytest run 2025-12-16 16:44:27 args=['tests/test_spotify_visualizer_widget.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 6 items



tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_tick_consumes_engine_smoothed_bars 
PASSED                              [ 16%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_compute_bars_reasonable_runtime 
PASSED                                 [ 33%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_widgets_share_audio_engine 
PASSED                                      [ 50%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_emits_perf_metrics 
PASSED                                              [ 66%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_bars_not_stuck_at_top 
PASSED                                           [ 83%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_kick_emphasizes_center_more_than_vocals 
PASSED                         [100%]




============================================================= 6 passed in 0.32s ==============================================================


===== pytest run 2025-12-16 16:44:29 args=['tests/test_context_menu_effect_invalidation.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 1 item



tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup 
FAILED                               [100%]




================================================================== FAILURES ==================================================================

_____________________________________________ test_context_menu_invalidates_effects_before_popup _____________________________________________



qt_app = <PySide6.QtWidgets.QApplication(0x2be20440890) at 0x000002BE4F62BD80>, qtbot = <pytestqt.qtbot.QtBot object at 0x000002BE4F9B7910>

settings_manager = <core.settings.settings_manager.SettingsManager(0x2be2043e650) at 0x000002BE4F9B66C0>

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000002BE4F9D7F50>



    @pytest.mark.qt

    def test_context_menu_invalidates_effects_before_popup(qt_app, qtbot, settings_manager, monkeypatch):

        widget = DisplayWidget(screen_index=0, display_mode=None, settings_manager=settings_manager)

        qtbot.addWidget(widget)

        widget.resize(640, 360)

    

        dummy = QWidget(widget)

        dummy.resize(20, 20)

        dummy.show()

    

        eff = QGraphicsDropShadowEffect(dummy)

        dummy.setGraphicsEffect(eff)

    

        events: List[Tuple[str, object]] = []

    

        orig_invalidate = widget._invalidate_overlay_effects  # type: ignore[attr-defined]

    

        def _spy_invalidate(reason: str) -> None:

            events.append(("invalidate", reason))

            orig_invalidate(reason)

    

        monkeypatch.setattr(widget, "_invalidate_overlay_effects", _spy_invalidate)

    

        last_popup_menu: List[object] = []

    

        def _spy_popup(self, pos):  # type: ignore[no-untyped-def]

            last_popup_menu.clear()

            last_popup_menu.append(self)

            events.append(("popup", pos))

            assert any(e[0] == "invalidate" for e in events)

    

        monkeypatch.setattr(ScreensaverContextMenu, "popup", _spy_popup)

    

        widget.clock_widget = dummy  # type: ignore[assignment]

    

        effect_ids: List[int] = []

    

        for i in range(25):

            events.clear()

            widget._show_context_menu(QPoint(10 + i, 10))  # type: ignore[attr-defined]

            qt_app.processEvents()

            assert events

    

            try:

                active_eff = dummy.graphicsEffect()

            except Exception:

                active_eff = None

            assert isinstance(active_eff, QGraphicsDropShadowEffect)

            effect_ids.append(id(active_eff))

    

            invalidate_idx = next(idx for idx, e in enumerate(events) if e[0] == "invalidate")

            popup_idx = next(idx for idx, e in enumerate(events) if e[0] == "popup")

            assert invalidate_idx < popup_idx

    

            menu = last_popup_menu[0] if last_popup_menu else None

            assert menu is not None

            try:

                menu.aboutToHide.emit()

            except Exception:

                pass

            qt_app.processEvents()

    

            assert any(

                e[0] == "invalidate" and str(e[1]).startswith("menu_after_hide")

                for e in events

            )

    

>       assert len(set(effect_ids)) >= 2

E       assert 1 >= 2

E        +  where 1 = len({3016398250752})

E        +    where {3016398250752} = set([3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752])



tests\test_context_menu_effect_invalidation.py:81: AssertionError

----------------------------------------------------------- Captured log teardown ------------------------------------------------------------

WARNING  SettingsManager:settings_manager.py:842 All settings cleared

========================================================== short test summary info ===========================================================

FAILED tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup - assert 1 >= 2
 +  where 1 = len({3016398250752})
 +    where {3016398250752} = set([3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752, 3016398250752])


============================================================= 1 failed in 0.61s ==============================================================


===== pytest run 2025-12-16 16:46:33 args=['tests/test_context_menu_effect_invalidation.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 1 item



tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup 
FAILED                               [100%]




================================================================== FAILURES ==================================================================

_____________________________________________ test_context_menu_invalidates_effects_before_popup _____________________________________________



qt_app = <PySide6.QtWidgets.QApplication(0x1e8cc1c7160) at 0x000001E8FBAA32C0>, qtbot = <pytestqt.qtbot.QtBot object at 0x000001E8FBAA3650>

settings_manager = <core.settings.settings_manager.SettingsManager(0x1e8cb600320) at 0x000001E8FBAA3A40>

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001E8FBABFF50>



    @pytest.mark.qt

    def test_context_menu_invalidates_effects_before_popup(qt_app, qtbot, settings_manager, monkeypatch):

        widget = DisplayWidget(screen_index=0, display_mode=None, settings_manager=settings_manager)

        qtbot.addWidget(widget)

        widget.resize(640, 360)

    

        dummy = QWidget(widget)

        dummy.resize(20, 20)

        dummy.show()

    

        eff = QGraphicsDropShadowEffect(dummy)

        dummy.setGraphicsEffect(eff)

    

        events: List[Tuple[str, object]] = []

    

        orig_invalidate = widget._invalidate_overlay_effects  # type: ignore[attr-defined]

    

        def _spy_invalidate(reason: str) -> None:

            events.append(("invalidate", reason))

            orig_invalidate(reason)

    

        monkeypatch.setattr(widget, "_invalidate_overlay_effects", _spy_invalidate)

    

        last_popup_menu: List[object] = []

    

        def _spy_popup(self, pos):  # type: ignore[no-untyped-def]

            last_popup_menu.clear()

            last_popup_menu.append(self)

            events.append(("popup", pos))

            assert any(e[0] == "invalidate" for e in events)

    

        monkeypatch.setattr(ScreensaverContextMenu, "popup", _spy_popup)

    

        widget.clock_widget = dummy  # type: ignore[assignment]

    

        effect_ids: List[int] = []

    

        for i in range(25):

            events.clear()

            widget._show_context_menu(QPoint(10 + i, 10))  # type: ignore[attr-defined]

            qt_app.processEvents()

            assert events

    

            try:

                active_eff = dummy.graphicsEffect()

            except Exception:

                active_eff = None

            assert isinstance(active_eff, QGraphicsDropShadowEffect)

            effect_ids.append(id(active_eff))

    

            invalidate_idx = next(idx for idx, e in enumerate(events) if e[0] == "invalidate")

            popup_idx = next(idx for idx, e in enumerate(events) if e[0] == "popup")

            assert invalidate_idx < popup_idx

    

            menu = last_popup_menu[0] if last_popup_menu else None

            assert menu is not None

            try:

                menu.aboutToHide.emit()

            except Exception:

                pass

            qt_app.processEvents()

    

            assert any(

                e[0] == "invalidate" and str(e[1]).startswith("menu_after_hide")

                for e in events

            )

    

>       assert len(set(effect_ids)) >= 2

E       assert 1 >= 2

E        +  where 1 = len({2100166577856})

E        +    where {2100166577856} = set([2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856])



tests\test_context_menu_effect_invalidation.py:81: AssertionError

----------------------------------------------------------- Captured log teardown ------------------------------------------------------------

WARNING  SettingsManager:settings_manager.py:842 All settings cleared

========================================================== short test summary info ===========================================================

FAILED tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup - assert 1 >= 2
 +  where 1 = len({2100166577856})
 +    where {2100166577856} = set([2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856, 2100166577856])


============================================================= 1 failed in 0.70s ==============================================================


===== pytest run 2025-12-16 16:47:32 args=['tests/test_context_menu_effect_invalidation.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 1 item



tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup 
PASSED                               [100%]




============================================================= 1 passed in 0.50s ==============================================================


===== pytest run 2025-12-16 16:54:47 args=['tests/test_spotify_visualizer_widget.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 6 items



tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_tick_consumes_engine_smoothed_bars 
PASSED                              [ 16%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_compute_bars_reasonable_runtime 
PASSED                                 [ 33%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_widgets_share_audio_engine 
PASSED                                      [ 50%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_emits_perf_metrics 
PASSED                                              [ 66%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_bars_not_stuck_at_top 
PASSED                                           [ 83%]


tests/test_spotify_visualizer_widget.py::test_spotify_visualizer_kick_emphasizes_center_more_than_vocals 
PASSED                         [100%]




============================================================= 6 passed in 0.53s ==============================================================


===== pytest run 2025-12-16 16:54:49 args=['tests/test_context_menu_effect_invalidation.py', '-vv', '--tb=long'] =====

============================================================ test session starts =============================================================

platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe

cachedir: .pytest_cache

PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1

rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver

configfile: pytest.ini

plugins: qt-4.5.0

collecting ... 
collected 1 item



tests/test_context_menu_effect_invalidation.py::test_context_menu_invalidates_effects_before_popup 
PASSED                               [100%]




============================================================= 1 passed in 0.78s ==============================================================

