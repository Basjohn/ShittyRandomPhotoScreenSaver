============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-8.4.1, pluggy-1.6.0 -- C:\Python311\python.exe
cachedir: .pytest_cache
PySide6 6.9.1 -- Qt runtime 6.9.1 -- Qt compiled 6.9.1
rootdir: F:\Programming\Apps\ShittyRandomPhotoScreenSaver
configfile: pytest.ini
plugins: qt-4.5.0
collecting ... collected 3 items

tests/test_activation_transparency_regression.py::test_displaywidget_single_focus_owner PASSED [ 33%]
tests/test_activation_transparency_regression.py::test_context_menu_overlay_works_on_non_focusable_display FAILED [ 66%]
tests/test_activation_transparency_regression.py::test_context_menu_overlay_shows_and_hides_without_sticky_flags FAILED [100%]QSettings: Failed to delete key "Software\Test\ScreensaverTest" (Illegal operation attempted on a registry key that has been marked for deletion.)
QSettings: Failed to delete key "Software\Test\ScreensaverTest" (Illegal operation attempted on a registry key that has been marked for deletion.)


================================== FAILURES ===================================
__________ test_context_menu_overlay_works_on_non_focusable_display ___________

qt_app = <PySide6.QtWidgets.QApplication(0x13765ca1e60) at 0x000001377F6FA200>
settings_manager = <core.settings.settings_manager.SettingsManager(0x13765ca5e40) at 0x000001377F76CF40>
qtbot = <pytestqt.qtbot.QtBot object at 0x000001377F7762D0>

    @pytest.mark.qt
    def test_context_menu_overlay_works_on_non_focusable_display(qt_app, settings_manager, qtbot):
        _reset_displaywidget_globals()
    
        owner = DisplayWidget(screen_index=0, display_mode=DisplayMode.FILL, settings_manager=settings_manager)
        other = DisplayWidget(screen_index=1, display_mode=DisplayMode.FILL, settings_manager=settings_manager)
        qtbot.addWidget(owner)
        qtbot.addWidget(other)
        owner.resize(320, 240)
        other.resize(320, 240)
        owner.show()
        other.show()
        qt_app.processEvents()
    
        assert owner.focusPolicy() == Qt.FocusPolicy.StrongFocus
        assert other.focusPolicy() == Qt.FocusPolicy.NoFocus
    
        assert getattr(other, "_context_menu_overlay", None) is None
        assert getattr(other, "_context_menu_active", False) is False
        assert DisplayWidget._global_context_menu_active is False
    
        other._show_context_menu(QPoint(10, 10))
        qt_app.processEvents()
    
        menu = getattr(other, "_context_menu_overlay", None)
>       assert isinstance(menu, ScreensaverContextMenuOverlay)
E       assert False
E        +  where False = isinstance(None, ScreensaverContextMenuOverlay)

tests\test_activation_transparency_regression.py:61: AssertionError
---------------------------- Captured log teardown ----------------------------
WARNING  SettingsManager:settings_manager.py:837 All settings cleared
_______ test_context_menu_overlay_shows_and_hides_without_sticky_flags ________

qt_app = <PySide6.QtWidgets.QApplication(0x13765ca1e60) at 0x000001377F6FA200>
settings_manager = <core.settings.settings_manager.SettingsManager(0x13765ca5b80) at 0x0000013716F62C40>
qtbot = <pytestqt.qtbot.QtBot object at 0x0000013716F62210>

    @pytest.mark.qt
    def test_context_menu_overlay_shows_and_hides_without_sticky_flags(qt_app, settings_manager, qtbot):
        _reset_displaywidget_globals()
    
        w0 = DisplayWidget(screen_index=0, display_mode=DisplayMode.FILL, settings_manager=settings_manager)
        qtbot.addWidget(w0)
        w0.resize(320, 240)
        w0.show()
        qt_app.processEvents()
    
        assert getattr(w0, "_context_menu_overlay", None) is None
        assert getattr(w0, "_context_menu_active", False) is False
        assert DisplayWidget._global_context_menu_active is False
    
        w0._show_context_menu(QPoint(10, 10))
        qt_app.processEvents()
    
        menu = getattr(w0, "_context_menu_overlay", None)
>       assert isinstance(menu, ScreensaverContextMenuOverlay)
E       assert False
E        +  where False = isinstance(None, ScreensaverContextMenuOverlay)

tests\test_activation_transparency_regression.py:91: AssertionError
---------------------------- Captured log teardown ----------------------------
WARNING  SettingsManager:settings_manager.py:837 All settings cleared
=========================== short test summary info ===========================
FAILED tests/test_activation_transparency_regression.py::test_context_menu_overlay_works_on_non_focusable_display - assert False
 +  where False = isinstance(None, ScreensaverContextMenuOverlay)
FAILED tests/test_activation_transparency_regression.py::test_context_menu_overlay_shows_and_hides_without_sticky_flags - assert False
 +  where False = isinstance(None, ScreensaverContextMenuOverlay)
========================= 2 failed, 1 passed in 1.38s =========================
